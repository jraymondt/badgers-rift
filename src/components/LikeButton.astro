---
interface Props {
  postSlug: string;
}

const { postSlug } = Astro.props;
const likeId = `like-${postSlug}`;
---

<div class="like-container">
  <button 
    id={likeId}
    class="like-button"
    data-post-slug={postSlug}
    title="Like this post"
  >
    ‚ù§Ô∏è <span class="like-count">...</span>
  </button>
  <button class="share-button" onclick={`shareOnFacebook('${postSlug}')`}>
    üìò Share
  </button>
</div>

<script>
  // Find all like buttons on the page
  const buttons = document.querySelectorAll('button.like-button');

  buttons.forEach((btn) => {
    // @ts-ignore
    const button = btn;
    const slug = button.getAttribute('data-post-slug');
    const countSpan = button.querySelector('.like-count');

    if (!slug || !countSpan) return;

    // Fetch current count
    fetch(`/api/likes/${slug}`)
      .then(res => res.json())
      .then(data => {
        countSpan.textContent = data.count || 0;
      })
      .catch(err => console.error('Error fetching likes:', err));

    // Handle click
    button.addEventListener('click', async () => {
      try {
        // Optimistic update
        const currentCount = parseInt(countSpan.textContent || '0');
        countSpan.textContent = (currentCount + 1).toString();
        
        // Disable button temporarily
        button.disabled = true;

        const res = await fetch(`/api/likes/${slug}`, { method: 'POST' });
        const data = await res.json();
        
        // Update with actual server count
        countSpan.textContent = data.count;
      } catch (err) {
        console.error('Error liking post:', err);
      } finally {
        button.disabled = false;
      }
    });
  });

  // Share function
  // @ts-ignore
  window.shareOnFacebook = function(slug) {
    const url = `${window.location.origin}/blog/${slug}/`;
    const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
    window.open(facebookUrl, "facebook-share", "width=600,height=400");
  };
</script>

<style>
  .like-container {
    display: flex;
    gap: 1em;
    margin: 2em 0;
    padding: 1.5em;
    border: 3px solid var(--cga-pink);
    background-color: rgba(196, 81, 158, 0.05);
  }

  .like-button,
  .share-button {
    padding: 0.75em 1.5em;
    border: 3px solid var(--cga-pink);
    background-color: var(--cga-navy);
    color: var(--cga-pink);
    font-family: 'IBM VGA', monospace;
    font-size: 1.2em;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .like-button:hover,
  .share-button:hover {
    background-color: var(--cga-pink);
    color: var(--cga-navy);
  }

  .like-button.liked {
    background-color: var(--cga-pink);
    color: var(--cga-navy);
  }

  .like-count {
    margin-left: 0.5em;
    font-weight: bold;
  }
</style>

